local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:FindFirstChild("HumanoidRootPart")
local lastFruit = nil
local fruitList = {}

-- Ki·ªÉm tra HRP
if not HumanoidRootPart then
    warn("Kh√¥ng t√¨m th·∫•y HumanoidRootPart!")
    return
end

-- Qu√©t danh s√°ch tr√°i m·ªôt l·∫ßn
for _, fruit in ipairs(workspace:GetChildren()) do
    if fruit:IsA("Model") and fruit:FindFirstChild("Handle") then
        table.insert(fruitList, fruit)
    end
end

-- T√¨m tr√°i √°c qu·ª∑ g·∫ßn nh·∫•t
local function findClosestFruit()
    local closestFruit = nil
    local closestDistance = math.huge
    for _, fruit in ipairs(fruitList) do
        local distance = (HumanoidRootPart.Position - fruit.Handle.Position).Magnitude
        if distance < closestDistance then
            closestFruit = fruit
            closestDistance = distance
        end
    end
    return closestFruit
end

-- Di chuy·ªÉn ƒë·∫øn tr√°i √°c qu·ª∑ (gi·∫£m t·ªëc ƒë·ªô ƒë·ªÉ tr√°nh lag)
local function goToFruit(fruit)
    if not fruit or not fruit:FindFirstChild("Handle") then return end
    
    lastFruit = fruit
    local tweenInfo = TweenInfo.new(0.8, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(HumanoidRootPart, tweenInfo, {Position = fruit.Handle.Position})
    tween:Play()
    tween.Completed:Wait()
    
    -- Auto Store Fruit n·∫øu c√≥ th·ªÉ
    if ReplicatedStorage:FindFirstChild("Remotes") and ReplicatedStorage.Remotes:FindFirstChild("CommF_") then
        ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", fruit.Name)
        print("üì¶ ƒê√£ t·ª± ƒë·ªông l∆∞u tr√°i:", fruit.Name)
    end
end

-- T·ªëi ∆∞u h√≥a hop server
local function hopServer()
    print("‚ö† Kh√¥ng t√¨m th·∫•y tr√°i, ƒëang hop server...")
    game.StarterGui:SetCore("SendNotification", {
        Title = "Th√¥ng b√°o",
        Text = "Kh√¥ng t√¨m th·∫•y tr√°i, hop server...",
        Duration = 3
    })
    
    local success, response = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=50")).data
    end)
    
    if success and response then
        for _, server in ipairs(response) do
            if server.id ~= game.JobId and server.playing < server.maxPlayers then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id, LocalPlayer)
                return
            end
        end
    else
        warn("L·ªói khi l·∫•y danh s√°ch server!")
    end
end

-- Ch·∫°y Auto Nh·∫∑t Tr√°i + Hop Server (T·ªëi ∆∞u hi·ªáu su·∫•t)
spawn(function()
    local startTime = tick()
    while task.wait(3) do -- Gi√£n c√°ch qu√©t ƒë·ªÉ tr√°nh spam
        local fruit = findClosestFruit()
        if fruit then
            goToFruit(fruit)
            startTime = tick()
        else
            print("Kh√¥ng t√¨m th·∫•y tr√°i √°c qu·ª∑!")
            game.StarterGui:SetCore("SendNotification", {
                Title = "Th√¥ng b√°o",
                Text = "Kh√¥ng t√¨m th·∫•y tr√°i √°c qu·ª∑!",
                Duration = 3
            })
            
            -- N·∫øu kh√¥ng c√≥ tr√°i sau 10 gi√¢y -> hop server
            if tick() - startTime >= 10 then
                hopServer()
                break
            end
        end
    end
end)
